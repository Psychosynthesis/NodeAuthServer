import{r as c,j as o,Y as d,I as m,s as w,c as v,B as b}from"./libs-7a07fc3c.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const a of e)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(e){const a={};return e.integrity&&(a.integrity=e.integrity),e.referrerPolicy&&(a.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?a.credentials="include":e.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(e){if(e.ep)return;e.ep=!0;const a=t(e);fetch(e.href,a)}})();const E=(r,s)=>{switch(s.type){case"setUserData":return{...r,user:s.load};case"setToken":return{...r,token:s.load};case"clearError":return{...r,error:[],networkError:null};case"pushError":return{...r,error:[...r.error,s.load]};case"setNetworkError":return{...r,networkError:s.load};default:throw new Error(`Unhandled action type: ${s.type}`)}},g=c.createContext(void 0),x=c.createContext(void 0),S={user:{username:null,userId:null,email:null,telegramUsername:null,telegramId:null},token:null,error:[],networkError:null},P=({children:r})=>{const[s,t]=c.useReducer(E,S);return o.jsx(g.Provider,{value:s,children:o.jsx(x.Provider,{value:t,children:r})})},k=()=>{const r=c.useContext(g);if(typeof r>"u")throw new Error("useAppState must be used within a AppStoreProvider");return r},A=()=>{const r=c.useContext(x);if(typeof r>"u")throw new Error("useAppDispatch must be used within a AppStoreProvider");return r},C=()=>[k(),A()],I=3e3,N="VERIFICATION_CODE",O="http://127.0.0.1:"+I+"/",R=r=>{const s=new Headers;return s.append("Content-Type","application/json"),s.append("X-verification-code",N),r&&Object.keys(r).forEach(t=>{r[t],s.append(t,r[t])}),s},p=({url:r,method:s,headers:t,body:n})=>window.fetch(O+r,{method:s,headers:R(t),credentials:"include",body:JSON.stringify(n)}).then(e=>e.ok?e.json():Promise.reject(e)).then(e=>({error:!1,data:e})).catch(e=>typeof e.json=="function"?e.json().then(a=>(console.error("Json error from API: ",a),a)).catch(()=>(console.error("Generic error from API: ",e.statusText),e)):(console.error("Fetch error: ",e),e)),T=()=>p({url:"api/auth/updateToken",method:"POST"}),L=({username:r,pass:s})=>p({url:"api/auth/login",method:"POST",body:{username:r,pass:s}}),D=({username:r,mail:s,pass:t})=>p({url:"api/auth/register",method:"POST",body:{username:r,mail:s,pass:t}}),U=r=>p({url:"api/auth/getUser",method:"GET",headers:{"X-csrf-token":r}}),i={error:!0,data:null},y=()=>{const[r,s]=C();return{updateToken:async()=>{try{const t=await T();return t.error||!t.data?{...i,message:t.message}:{...i,error:!1,data:t.data}}catch(t){return t.message}},register:async t=>{try{const n=await D(t);return n.error||!n.data?{...i,message:n.message}:{...i,error:!1,data:n.data}}catch(n){return n.message}},login:async t=>{var n;try{const e=await L(t);return!e.data||!((n=e.data)!=null&&n.token)||e.error?{...i,message:e.message}:{...i,error:!1,data:e.data}}catch(e){return e.message}},getUser:async()=>{try{if(!r.token)throw new Error("No token!");const t=await U(r.token);return!t.data||t.error?{...i,message:t.message}:{...i,error:!1,data:t.data}}catch(t){return{...i,message:t.message}}}}},F=()=>{const r=y(),[s,t]=c.useState(""),[n,e]=c.useState(""),[a,l]=c.useState(""),[f,u]=c.useState(null),j=()=>{u(null),r.register({mail:s,username:n,pass:a}).then(h=>{h.error?u(h.message):u("Вы успешно зарегистрированы, теперь вы можете войти")})};return o.jsxs("div",{children:[o.jsx(d,{value:s,valueSetter:t,placeholder:"E-mail",label:"E-mail",borderColor:"#ffffff"}),o.jsx("br",{}),o.jsx(d,{value:n,valueSetter:e,placeholder:"Минимум 4 символа",label:"Nickname",borderColor:"#ffffff"}),o.jsx("br",{}),o.jsx(d,{value:a,valueSetter:l,placeholder:"Password",label:"Password",borderColor:"#ffffff"}),o.jsx("br",{}),f&&o.jsx("div",{className:"errors",children:f}),o.jsx("div",{className:"control-row",children:o.jsx(m,{onClick:j,children:"Register"})})]})},_=()=>{const r=y(),[s,t]=c.useState(""),[n,e]=c.useState(""),[a,l]=c.useState(null),f=()=>{l(null),r.login({username:s,pass:n}).then(u=>{u.error?l(u.message):(w("hash",u.data.token,36e3),l("Вы будете перенаправлены. Если перенаправление не работает, перейдите на адрес /list"),window.location.replace("/list"))})};return o.jsxs("div",{children:[o.jsx(d,{value:s,valueSetter:t,placeholder:"Минимум 4 символа",label:"Nickname",borderColor:"#ffffff"}),o.jsx("br",{}),o.jsx(d,{value:n,valueSetter:e,placeholder:"Password",label:"Password",borderColor:"#ffffff"}),o.jsx("br",{}),a&&o.jsx("div",{className:"errors",children:a}),o.jsx("div",{className:"control-row",children:o.jsx(m,{onClick:f,children:"Login"})})]})};const B=document.getElementById("main-node"),M=()=>{const r=window.location.href.includes("login")?0:1;return o.jsxs("div",{className:"auth-form main-layout",children:[o.jsx("h2",{style:{textAlign:"center"},children:"Auth"}),o.jsx("div",{children:o.jsx("div",{style:{display:"flex",justifyContent:"space-around"},children:o.jsx(b,{defaultIndex:r,tabs:[{caption:"Login",content:o.jsx(_,{})},{caption:"Register",content:o.jsx(F,{})}]})})})]})};v(B).render(o.jsx(c.StrictMode,{children:o.jsx(P,{children:o.jsx(M,{})})}));export{P as A,C as a,M as b,y as u};
