import{r as c,j as o,Y as f,I as w,c as E,B as v}from"./libs-4d915eec.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function r(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(t){if(t.ep)return;t.ep=!0;const a=r(t);fetch(t.href,a)}})();const b=(e,s)=>{switch(s.type){case"setUserData":return{...e,user:s.load};case"clearUserData":return{...e,user:{...j.user}};case"setToken":return{...e,token:s.load};case"clearError":return{...e,error:[],networkError:null};case"pushError":return{...e,error:[...e.error,s.load]};case"setNetworkError":return{...e,networkError:s.load};default:throw new Error(`Unhandled action type: ${s.type}`)}},y=c.createContext(void 0),S=c.createContext(void 0),j={user:{username:null,userId:null,email:null,telegramUsername:null,telegramId:null},token:null,error:[],networkError:null},k=({children:e})=>{const[s,r]=c.useReducer(b,j);return o.jsx(y.Provider,{value:s,children:o.jsx(S.Provider,{value:r,children:e})})},P=()=>{const e=c.useContext(y);if(typeof e>"u")throw new Error("useAppState must be used within a AppStoreProvider");return e},I=()=>{const e=c.useContext(S);if(typeof e>"u")throw new Error("useAppDispatch must be used within a AppStoreProvider");return e},A=()=>[P(),I()],N=3e3,C="VERIFICATION_CODE",T=18,X=864e5,O="http://127.0.0.1:"+N+"/",L=e=>{const s=new Headers;return s.append("Content-Type","application/json"),s.append("X-verification-code",C),e&&Object.keys(e).forEach(r=>{s.append(r,e[r])}),s},h=({url:e,method:s,headers:r,body:n})=>window.fetch(O+e,{method:s,headers:L(r),credentials:"include",body:JSON.stringify(n)}).then(t=>t.ok?t.json():Promise.reject(t)).then(t=>({error:!1,data:t})).catch(t=>typeof t.json=="function"?t.json().then(a=>(console.error("Json error from API: ",a),a)).catch(()=>(console.error("Generic error from API: ",t.statusText),t)):(console.error("Fetch error: ",t),t)),D=({username:e,pass:s})=>h({url:"api/auth/login",method:"POST",body:{username:e,pass:s}}),U=e=>h({url:"api/auth/logout",method:"GET",headers:{"X-csrf-token":e}}),M=({username:e,mail:s,pass:r})=>h({url:"api/auth/register",method:"POST",body:{username:e,mail:s,pass:r}}),R=()=>h({url:"api/auth/updateToken",method:"POST"}),x=e=>h({url:"api/auth/getUser",method:"GET",headers:{"X-csrf-token":e}}),i={error:!0,data:null},p=()=>{const[e,s]=A();return{updateToken:async()=>{try{const r=await R();return r.error||!r.data?{...i,message:r.message}:{...i,error:!1,data:r.data}}catch(r){return r.message}},register:async r=>{try{const n=await M(r);return n.error||!n.data?{...i,message:n.message}:{...i,error:!1,data:n.data}}catch(n){return n.message}},login:async r=>{try{return await D(r).then(t=>{var a;return!t.data||!((a=t.data)!=null&&a.token)||t.error?{...i,message:t.message}:(x(t.data.token),{...i,error:!1,data:t.data})})}catch(n){return n.message}},logout:async()=>{try{if(!e.token)throw new Error("No token!");const r=await U(e.token);return!r.data||r.error?{...i,message:r.message}:{...i,error:!1,data:r.data}}catch(r){return r.message}},getUser:async()=>{try{if(!e.token)throw new Error("No token!");const r=await x(e.token);return!r.data||r.error?{...i,message:r.message}:{...i,error:!1,data:r.data}}catch(r){return{...i,message:r.message}}}}},_=()=>{const e=p(),[s,r]=c.useState(""),[n,t]=c.useState(""),[a,u]=c.useState(""),[m,d]=c.useState(null),l=()=>{d(null),e.register({mail:s,username:n,pass:a}).then(g=>{g.error?d(g.message):d("Вы успешно зарегистрированы, теперь вы можете войти")})};return o.jsxs("div",{children:[o.jsx(f,{value:s,valueSetter:r,placeholder:"E-mail",label:"E-mail",borderColor:"#ffffff"}),o.jsx("br",{}),o.jsx(f,{value:n,valueSetter:t,placeholder:"Минимум 4 символа",label:"Nickname",borderColor:"#ffffff"}),o.jsx("br",{}),o.jsx(f,{value:a,valueSetter:u,placeholder:"Password",label:"Password",borderColor:"#ffffff"}),o.jsx("br",{}),m&&o.jsx("div",{className:"errors",children:m}),o.jsx("div",{className:"control-row",children:o.jsx(w,{onClick:l,children:"Register"})})]})},F=()=>{const e=p(),[s,r]=c.useState(""),[n,t]=c.useState(""),[a,u]=c.useState(null),m=l=>{l.length>T||r(l.toLowerCase())},d=()=>{u(null),e.login({username:s,pass:n}).then(l=>{(l==null?void 0:l.error)===!1?(window.localStorage.setItem("session",String(new Date().getTime())),u("Вы будете перенаправлены. Если перенаправление не работает, перейдите на адрес /list"),setTimeout(()=>{window.location.replace("/list")},1e3)):u((l==null?void 0:l.message)??"Неизвестная ошибка")})};return o.jsxs("div",{children:[o.jsx(f,{value:s,valueSetter:m,placeholder:"Минимум 4 символа",label:"Nickname",borderColor:"#ffffff"}),o.jsx("br",{}),o.jsx(f,{value:n,valueSetter:t,placeholder:"Password",label:"Password",borderColor:"#ffffff"}),o.jsx("br",{}),a&&o.jsx("div",{className:"errors",children:a}),o.jsx("div",{className:"control-row",children:o.jsx(w,{onClick:d,children:"Login"})})]})};const G=document.getElementById("main-node"),B=()=>{const e=p(),s=window.location.href.includes("login")?0:1;return c.useEffect(()=>{+window.localStorage.getItem("session")||e.updateToken().then(n=>{window.localStorage.setItem("session",String(new Date().getTime())),n.error===!1&&window.location.replace("/list")})},[]),o.jsxs("div",{className:"auth-form main-layout",children:[o.jsx("h2",{style:{textAlign:"center"},children:"Auth"}),o.jsx("div",{children:o.jsx("div",{style:{display:"flex",justifyContent:"space-around"},children:o.jsx(v,{defaultIndex:s,tabs:[{caption:"Login",content:o.jsx(F,{})},{caption:"Register",content:o.jsx(_,{})}]})})})]})};E(G).render(o.jsx(c.StrictMode,{children:o.jsx(k,{children:o.jsx(B,{})})}));export{k as A,X as S,A as a,B as b,p as u};
